upstream  {{project_name}}_upstream {
    server unix:/home/projects/{{project_name}}/{{project_name}}/tmp/gunicorn.sock fail_timeout=0;
}

# server {
#     listen 80;
#     server_name {{project_name}}.cruncher.ch {{project_name}}.com www.{{project_name}}.com;
#     rewrite ^(.*) https://www.{{project_name}}.com$1 permanent;
# }

server {
    # listen 443;
    # proxy_set_header X-Forwarded-Protocol https;
    
    listen 80;
    proxy_set_header X-Forwarded-Protocol http;
    
    server_name {{project_name}}.cruncher.ch;
    access_log  /var/log/nginx/{{project_name}}.access.log;
    charset utf-8;
    server_tokens off;
	
    gzip on;
    gzip_comp_level 2;
    gzip_proxied any;
    gzip_types text/plain text/css application/json text/javascript application/x-javascript font/ttf font/otf image/svg+xml;
    
    # ssl on;
    # ssl_certificate /home/projects/{{project_name}}/{{project_name}}/conf/prod/ssl/server.crt;
    # ssl_certificate_key /home/projects/{{project_name}}/{{project_name}}/conf/prod/ssl/server.key;
    # ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  
    client_max_body_size 100M;
    root /home/projects/{{project_name}}/{{project_name}}/docroot;
    
    location /static/ {
	   root /home/projects/{{project_name}}/{{project_name}}/tmp;
	   expires 30d;
    }
    location /media/ {
	root /home/projects/{{project_name}}/{{project_name}}/tmp;
	expires 30d;
    }
    location / {

        # auth_basic "Restricted Zone";
        # auth_basic_user_file /home/projects/{{project_name}}/{{project_name}}/conf/prod/htpasswd.conf;

        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_connect_timeout 10;
        proxy_read_timeout 10;
        proxy_pass http://{{project_name}}_upstream;
    }
}
